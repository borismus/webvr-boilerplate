<!--
  Test swapping a canvas embedded in an existing web page layout into 
  fullscreen and Fullscreen VR mode.
-->
<head>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
/* reset */
body, header, section, footer, figure, h1 { /*often have default margin in browser stylesheets*/
  margin:0;
  border:0;
  padding:0;
}
/* basic body styles */
body {
  width: 100%;
  height: 100%;
  background-color: #000;
  color: #fff;
  margin: 0;
  padding: 0;
  overflow: hidden;
}
header, section, footer {
  width:100%;
  border-bottom: 1px solid green;
}
/* debugging only */
canvas {
  border: 1px solid yellow;
  /* width:80%!important; can't do this with THREE.js, must use renderer.setSize() */;
}
figure {

}
figcaption {

}
/* webvr-boilerplate specific styles*/
.webvr-player-container {
  
}
.webvr-controls-container {
  border:1px solid red;
}

</style>
</head>

<body>
  <div class="webvr-dom-container">
    <header>
      <h1>Page Header:WebVR in DOM</h1>
      <button style="display:fixed; bottom:0; left:0;" onclick="WebVRManager.Util.moveCanvas(document.getElementById('webvr-test-canvas'))">Toggle DOM Swap</button>
    </header>
    <main>
        <section id="content">
          <h2>Page Content Section</h2>
          <!--markup for webvr player-->
          <figure class="webvr-player-container">
            <canvas id="webvr-test-canvas">WebVR not Supported, upgrade browser!</canvas>
          <div class="webvr-controls-container"></div>
          </figure>
      </section>
      <footer>
        <h2>Page Footer</h2>
      </footer>
    </main>
  </div>
</body>

<script src="../bower_components/threejs/build/three.js"></script>
<script src="../bower_components/threejs/examples/js/controls/VRControls.js"></script>
<script src="../bower_components/threejs/examples/js/effects/VREffect.js"></script>
<script src="../bower_components/webvr-polyfill/build/webvr-polyfill.js"></script>
<script src="../build/webvr-manager.js"></script>

<script>
// Wrap setup in DOMContentLoaded event so DOM can render, and CSS .getComputedStyle works
document.addEventListener('DOMContentLoaded', function() {

// Setup three.js WebGL renderer
var renderer = new THREE.WebGLRenderer({ 
  canvas:document.getElementById('webvr-test-canvas'),
  antialias: true 
});
renderer.setPixelRatio(window.devicePixelRatio);

// Append the canvas element created by the renderer to document body element.
if(renderer.domElement.id || renderer.domElement.className) {
  //nothing
} else {
  document.body.appendChild(renderer.domElement);
}

//Test settings for canvas with a fixed size (rather than bound to window size).
//TODO: make relative option (can't do this with CSS styesheet alone).
var canvasStyle = {
  width:1200,
  height:800
};
//canvasStyle.width = window.innerWidth;
//canvasStyle.height = window.innerHeight;

// Create a three.js scene.
var scene = new THREE.Scene();

// Create a three.js camera.
var camera = new THREE.PerspectiveCamera(75, canvasStyle.width / canvasStyle.height, 0.1, 10000);

// Apply VR headset positional data to camera.
var controls = new THREE.VRControls(camera);

// Apply VR stereo rendering to renderer.
var effect = new THREE.VREffect(renderer);
effect.setSize(canvasStyle.width, canvasStyle.height);
// Adjust our element
renderer.setSize(canvasStyle.width, canvasStyle.height); //TODO: IS THIS NEEDED?

// Add a repeating grid as a skybox.
var boxWidth = 5;
var texture = THREE.ImageUtils.loadTexture(
  '../img/box.png'
);
texture.wrapS = THREE.RepeatWrapping;
texture.wrapT = THREE.RepeatWrapping;
texture.repeat.set(boxWidth, boxWidth);

var geometry = new THREE.BoxGeometry(boxWidth, boxWidth, boxWidth);
var material = new THREE.MeshBasicMaterial({
  map: texture,
  color: 0x01BE00,
  side: THREE.BackSide
});

var skybox = new THREE.Mesh(geometry, material);
scene.add(skybox);

// Create a VR manager helper to enter and exit VR mode.
// TODO: define list of parameters. Need additional params for canvas to function inside DOM.
var manager = new WebVRManager(renderer, effect, camera, {id:'first-vr-scene', hideButton: false, showCaption:true, caption:'WebVR Window with Controls'});

// Create 3D objects.
var geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
var material = new THREE.MeshNormalMaterial();
var cube = new THREE.Mesh(geometry, material);

// Position cube mesh
cube.position.z = -1;

// Add cube mesh to your three.js scene
scene.add(cube);

// Request animation frame loop function
function animate(timestamp) {
  // Apply rotation to cube mesh
  cube.rotation.y += 0.01;

  // Update VR headset position and apply to camera.
  controls.update();

  // Render the scene through the manager.
  manager.render(scene, camera, timestamp);

  requestAnimationFrame(animate);
}

// Kick off animation loop
animate();

// Reset the position sensor when 'z' pressed.
function onKey(event) {
  if (event.keyCode == 90) { // z
    controls.resetSensor();
  }
}

window.addEventListener('keydown', onKey, true);

}); //end of DOMContentLoaded

</script>
